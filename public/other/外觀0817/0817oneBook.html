<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>書籍詳情 - 圖書館</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* 引入 Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');

        /* 自定義樣式 - 參考 jy-contents 風格 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: rgba(112, 112, 112, 0.85); /* 頁面外背景色 */
            box-sizing: border-box;
        }
        .text-outline {
            -webkit-text-stroke: 1px black;
            text-stroke: 1px black;
        }
        /* 登入 Modal 樣式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border: 2px solid black;
            width: 90%;
            max-width: 400px;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            background: none;
            cursor: pointer;
        }
        /* 狀態點樣式 */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border: 1px solid black;
            margin-right: 8px;
        }
        .status-available { background-color: #10b981; }
        .status-borrowed { background-color: #ef4444; }
        .status-reserved { background-color: #f59e0b; }
        .status-other { background-color: #6b7280; }
    </style>
</head>
<body class="bg-[#ededed] min-h-screen flex flex-col">

<div id="app" class="max-w-[1500px] mx-auto border-l border-r border-black flex flex-col flex-grow w-full"><!-- flex flex-col flex-grow w-full 讓footer觸底 -->
    <!-- 導覽列 (header) -->
    <header class="bg-white text-black p-1 border-b border-black">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <a href="/" class="text-5xl font-black rounded-md transition">日比野線上圖書館 V2</a>
            <div class="flex items-center space-x-2">
                <div class="relative">
                    <input type="text" placeholder="搜尋書籍..." class="py-2 px-4 border border-black focus:outline-none focus:ring-2 focus:ring-yellow-400 w-48">
                </div>
                <a v-if="isLoggedIn" :href="'/html/myPage'" class="font-bold hover:bg-yellow-200 p-2 border border-black">個人頁面</a>
                <a href="/html/admin/adminPanel" class="font-bold hover:bg-yellow-200 p-2 border border-black">管理者頁面</a>
                <button @click="isLoggedIn ? logout() : showLoginModal()"
                        class="bg-pink-500 hover:bg-pink-600 text-white font-black py-2 px-4 border border-black transition-all duration-300 flex items-center space-x-2">
                    <span>{{ isLoggedIn ? '登出' : '登入' }}</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主要內容容器 -->
    <main class="container mx-auto p-1 md:p-1 flex-grow">
        <!-- 導航區 -->
        <div class="mb-1">
            <button @click="goBack"
                    class="bg-white hover:bg-yellow-200 text-black font-black p-2 border border-black transition-colors duration-200 flex items-center space-x-2">
                <span>&lt; 返回書籍列表</span>
            </button>
        </div>

        <!-- 加載中/錯誤訊息 -->
        <div v-if="loading" class="flex items-center justify-center p-12 border border-black">
            <span class="text-xl font-black animate-pulse">加載中...</span>
        </div>
        <div v-if="error" class="p-4 bg-red-200 border border-black font-bold mb-6">
            {{ error }}
        </div>

        <!-- 書籍詳情內容 -->
        <div v-if="!loading && !error" class="flex flex-col space-y-1">

            <!-- 上框：書籍資訊 -->
            <div class="border border-black p-1 flex flex-col md:flex-row items-center md:items-start gap-8">
                <!-- 書籍封面 -->
                <div class="flex-shrink-0 w-64 md:w-80 border border-black">
                    <img :src="bookDetails.imageUrl || 'https://placehold.co/320x480/e2e8f0/64748b?text=無圖片'"
                         :alt="bookDetails.title"
                         class="w-full h-auto object-contain"
                         onerror="this.onerror=null;this.src='https://placehold.co/320x480/e2e8f0/64748b?text=無圖片';" />
                </div>

                <!-- 書本詳細資訊 -->
                <div class="flex-grow w-full">
                    <h1 class="text-4xl font-black text-black mb-4">{{ bookDetails.title || '載入中...' }}</h1>
                    <div v-if="bookDetails.id" class="space-y-3 font-normal text-gray-800">
                        <p><strong>作者:</strong> {{ bookDetails.authors ? bookDetails.authors.join(', ') : '未知作者' }}</p>
                        <p><strong>主類別:</strong> {{ bookDetails.mainCategoryTitle || '未知' }}</p>
                        <p><strong>次類別:</strong> {{ bookDetails.subCategoryTitle || '未知' }}</p>
                        <p><strong>出版商:</strong> {{ bookDetails.publisher || '未知出版商' }}</p>
                        <p><strong>出版年份:</strong> {{ bookDetails.publishYear || 'N/A' }}</p>
                        <p><strong>ISBN:</strong> {{ bookDetails.isbn || 'N/A' }}</p>
                        <p v-if="bookDetails.seriesTitle"><strong>系列:</strong> {{ bookDetails.seriesTitle }}</p>

                        <!-- 標籤 -->
                        <div v-if="bookDetails.tags && bookDetails.tags.length > 0">
                            <p class="mb-2"><strong>標籤:</strong></p>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="tag in bookDetails.tags" :key="tag.id"
                                      class="px-3 py-1 bg-blue-200 text-blue-800 text-sm font-bold border border-black">
                                    {{ tag }}
                                </span>
                            </div>
                        </div>

                        <div class="pt-4">
                            <h3 class="text-2xl font-black text-gray-800 mb-2">書籍簡介</h3>
                            <p class="text-gray-800 leading-relaxed whitespace-pre-wrap">{{ bookDetails.description || '暫無簡介。' }}</p>
                        </div>

                        <p class="text-lg font-black text-gray-800 pt-4">
                            可借閱: <span class="text-[#10B981]">{{ bookDetails.availableCopies || 0 }}</span> / 總數: {{ bookDetails.totalCopies || 1 }}
                        </p>
                    </div>
                    <div v-else class="text-gray-500 text-center py-10 font-bold">
                        載入書籍資訊中...
                    </div>
                </div>
            </div>

            <!-- 下框：借閱狀況 -->
            <div class="border border-black p-1">
                <h3 class="text-2xl font-black text-outline text-green-500 mb-4">借閱狀況</h3>
                <div v-if="bookCopies.length > 0">
                    <ul class="space-y-3 font-semibold">
                        <li v-for="copy in bookCopies" :key="copy.id"
                            :class="['flex items-center border-b border-dashed border-gray-400 pb-2',
                                      copy.statusDescription === '已借出' ? 'text-gray-400 font-normal' : 'text-gray-800 font-normal']">
                            <span :class="['status-dot', {
                                'status-available': copy.statusDescription === '可借閱',
                                'status-borrowed': copy.statusDescription === '已借出',
                                'status-reserved': copy.statusDescription === '已預約',
                                'status-other': !['可借閱', '已借出', '已預約'].includes(copy.statusDescription)
                            }]"></span>
                            <span>書籍編號: <strong>{{ copy.uniqueCode }}</strong> - 狀態: {{ copy.statusDescription }}</span>
                            <span v-if="copy.statusDescription === '已借出' && copy.dueDate" class="ml-4 text-sm text-red-600 font-bold">
                                (到期日: {{ formatDate(copy.dueDate) }})
                            </span>
                        </li>
                    </ul>
                </div>
                <div v-else class="text-gray-500 font-bold">
                    無借閱副本資訊。
                </div>

                <!-- 借閱按鈕 -->
                <div class="mt-6 text-right">
                    <button @click="borrowBook"
                            v-if="(bookDetails.availableCopies || 0) > 0 && isLoggedIn"
                            class="bg-green-500 hover:bg-green-600 text-white font-black p-2 border border-black">
                        借閱此書 (剩餘: {{ bookDetails.availableCopies || 0 }})
                    </button>
                    <button v-else-if="!isLoggedIn"
                            @click="showLoginModal"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-black p-2 border border-black">
                        登入後借閱
                    </button>
                    <button v-else
                            class="bg-gray-400 text-white font-black p-2 border border-black cursor-not-allowed">
                        暫無可借閱副本
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 尾部 (footer) -->
    <footer class="bg-gray-800 text-white p-6 mt-8">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; 2025 我的圖書館. 版權所有.</p>
            <div class="mt-2 space-x-4">
                <a href="#" class="hover:underline">關於我們</a>
                <a href="#" class="hover:underline">聯絡我們</a>
                <a href="#" class="hover:underline">隱私政策</a>
            </div>
        </div>
    </footer>

    <!-- 登入模態框 -->
    <div v-if="showLoginModalFlag" class="modal-overlay" @click.self="hideLoginModal">
        <div class="modal-content">
            <button class="close-button" @click="hideLoginModal">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-center">登入</h2>
            <form @submit.prevent="handleLogin">
                <div class="mb-4">
                    <label for="account" class="block font-bold mb-2">帳號:</label>
                    <input type="text" id="account" v-model="loginForm.account" class="border border-black w-full py-2 px-3 leading-tight focus:outline-none focus:ring-2 focus:ring-yellow-400" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block font-bold mb-2">密碼:</label>
                    <input type="password" id="password" v-model="loginForm.password" class="border border-black w-full py-2 px-3 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-yellow-400" required>
                </div>
                <div v-if="loginError" class="text-red-500 text-sm mb-4 text-center">{{ loginError }}</div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-yellow-400 hover:bg-yellow-500 text-black font-black py-2 px-4 border border-black w-full transition-colors duration-200">
                        登入
                    </button>
                </div>
            </form>
            <div class="mt-4 text-center">
                <a href="/html/register" class="text-blue-600 hover:underline font-semibold">
                    還沒有帳號？加入會員
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            // 響應式數據
            const bookDetails = ref({});
            const bookCopies = ref([]);
            const loading = ref(false);
            const error = ref(null);

            // 登入相關狀態
            const showLoginModalFlag = ref(false);
            const loginForm = ref({ account: '', password: '' });
            const loginError = ref('');
            const isLoggedIn = ref(false);
            const currentUserId = ref(null); // 從 JWT 獲取的使用者 ID
            const currentUserRole = ref(null); // 從 JWT 獲取的使用者角色
            const currentUsername = ref(null); // 新增：儲存使用者帳號

            /** TODO 借閱模框未移植 **/

            // --- Axios Interceptor (自動添加 JWT) ---
            axios.interceptors.request.use(
                config => {
                    const token = localStorage.getItem('jwtToken');
                    if (token) {
                        config.headers.Authorization = `Bearer ${token}`;
                    }
                    return config;
                },
                error => {
                    return Promise.reject(error);
                }
            );

            // --- 核心修改：檢查登入狀態的邏輯 ---
            /** TODO myPage index 的 jwt 解析方式略不同，待統一改 jose **/
            const checkLoginStatus = () => {
                // 現在只需檢查 token 是否存在及其有效性
                const token = localStorage.getItem('jwtToken');
                if (token) {
                    try {
                        // 1. 解碼 JWT 的 Payload 部分
                        const payloadBase64 = token.split('.')[1];
                        const base64 = payloadBase64.replace(/-/g, '+').replace(/_/g, '/'); // 增強解碼，處理 URL 安全的 Base64
                        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        }).join(''));
                        const decodedPayload = JSON.parse(jsonPayload);
                        // 2. 檢查 token 是否過期 (exp 是標準的過期時間聲明，單位是秒)
                        if (decodedPayload.exp * 1000 < Date.now()) {
                            // JWT 的 exp 欄位是以「秒」為單位的 UNIX 時間戳，而 JavaScript 的 Date.now() 回傳的是「毫秒」。
                            // 所以這裡 decodedPayload.exp \* 1000 是把秒轉成毫秒，才能和 Date.now() 正確比較。
                            // 是為了在頁面操作時即時判斷 JWT 是否已過期，避免使用已失效的 token 發送 API 請求。
                            console.log("Token 已過期。");
                            // 如果 token 過期，只移除 token 並重設狀態，不呼叫 logout() 避免無限循環
                            localStorage.removeItem('jwtToken');
                            isLoggedIn.value = false;
                            currentUserId.value = null;
                            currentUserRole.value = null;
                            currentUsername.value = null;
                            return;
                        }
                        // 3. 從解碼後的 payload 中取得資訊並更新狀態
                        isLoggedIn.value = true;
                        currentUserId.value = parseInt(decodedPayload.sub); // 'sub' 是使用者 ID
                        currentUserRole.value = decodedPayload.role;       // 'role' 是自訂聲明
                        currentUsername.value = decodedPayload.username; // 'username' 也是自訂聲明

                    } catch (e) {
                        console.error("無法解碼 JWT:", e);
                        // 如果 token 格式錯誤，同樣只移除 token 並重設狀態
                        localStorage.removeItem('jwtToken');
                        isLoggedIn.value = false;
                        currentUserId.value = null;
                        currentUserRole.value = null;
                        currentUsername.value = null;
                    }
                } else {
                    // 如果沒有 token，就是未登入狀態
                    isLoggedIn.value = false;
                    currentUserId.value = null;
                    currentUserRole.value = null;
                    currentUsername.value = null;
                }
            };

            // 顯示登入模態框
            const showLoginModal = () => {
                console.log('點擊登入按鈕 - 顯示模態框'); // 加入這行來調試
                showLoginModalFlag.value = true;
                loginError.value = ''; // 清除之前的錯誤訊息
                loginForm.value = { account: '', password: '' }; // 重置表單
            };

            // 隱藏登入模態框
            const hideLoginModal = () => {
                showLoginModalFlag.value = false;
            };

            // 處理登入請求
            const handleLogin = async () => {
                loginError.value = ''; // 清除錯誤訊息
                try {
                    const response = await axios.post('/api/auth/login', loginForm.value);
                    //const { jwt, userId, role } = response.data;
                    console.log(response.data);
                    const { jwtToken } = response.data;

                    // 儲存 JWT 和使用者資訊到 localStorage
                    localStorage.setItem('jwtToken', jwtToken);
                    //localStorage.setItem('userId', userId);
                    //localStorage.setItem('userRole', role);

                    alert('登入成功！');
                    // 【修正】登入成功後，直接重新整理頁面
                    window.location.reload();

                } catch (error) {
                    console.error('登入失敗:', error);
                    if (error.response && error.response.status === 401) {
                        loginError.value = '帳號或密碼錯誤，請重試。';
                    } else {
                        loginError.value = '登入時發生錯誤，請稍後再試。';
                    }
                }
            };

            // 處理登出
            const logout = () => {
                localStorage.removeItem('jwtToken');
                //localStorage.removeItem('userId');
                //localStorage.removeItem('userRole');
                checkLoginStatus(); // 更新登入狀態
                alert('已登出。');
                // 登出後可以導向首頁或刷新當前頁面
                window.location.href = '/'; // 回到根目錄首頁
            };


            // 從 URL 獲取書籍 ID
            const getBookIdFromUrl = () => {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            };


            // 獲取書籍詳情
            const fetchBookDetails = async (bookId) => {
                if (!bookId) {
                    error.value = '無效的書籍 ID';
                    return;
                }

                loading.value = true;
                error.value = null;

                try {
                    const response = await fetch(`/api/books/${bookId}`);
                    if (!response.ok) {
                        throw new Error(`無法獲取書籍詳情: ${response.status}`);
                    }

                    const data = await response.json();
                    bookDetails.value = data;
                    bookCopies.value = data.bookCopies || [];

                    console.log('成功獲取書籍詳情:', data);
                } catch (err) {
                    console.error('獲取書籍詳情失敗:', err);
                    error.value = '無法獲取書籍詳情，請稍後再試。';
                } finally {
                    loading.value = false;
                }
            };

            // 借閱書籍
            const borrowBook = async () => {
                if (!isLoggedIn.value) {
                    alert('請先登入才能借閱書籍');
                    return;
                }

                const token = localStorage.getItem('token');
                if (!token) {
                    alert('登入狀態異常，請重新登入');
                    redirectToLogin();
                    return;
                }

                try {
                    const response = await fetch('/api/loans', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ bookId: bookDetails.value.id })
                    });

                    if (response.ok) {
                        alert('書籍借閱成功！');
                        // 重新獲取書籍詳情以更新可借閱數量
                        await fetchBookDetails(bookDetails.value.id);
                    } else {
                        const errorData = await response.json();
                        alert(`借閱失敗: ${errorData.message || '未知錯誤'}`);
                    }
                } catch (err) {
                    console.error('借閱失敗:', err);
                    alert('借閱失敗，請稍後再試。');
                }
            };

            // 返回書籍列表
            const goBack = () => {
                if (document.referrer && document.referrer.includes(window.location.origin)) {
                    window.history.back();
                } else {
                    window.location.href = '/other/外觀0817/0817bookQuery.html';
                }
            };

            // 重定向到登入頁面
            const redirectToLogin = () => {
                window.location.href = '/other/外觀0817/0817index.html';
            };

            // 格式化日期
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-TW');
            };

            // 生命週期鉤子
            onMounted(() => {
                checkLoginStatus(); // 檢查登入狀態
                const bookId = getBookIdFromUrl();
                if (bookId) {
                    fetchBookDetails(bookId);
                } else {
                    error.value = '未提供書籍 ID';
                }
            });

            return {
                bookDetails,
                bookCopies,
                loading,
                error,
                borrowBook,
                goBack,
                formatDate,

                // 登入相關
                showLoginModalFlag,
                loginForm,
                loginError,
                isLoggedIn,
                currentUserId,
                currentUserRole,
                showLoginModal,
                hideLoginModal,
                handleLogin,
                logout

            };
        }
    }).mount('#app');
</script>

</body>
</html>
