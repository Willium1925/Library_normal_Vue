<template>
  <div class="flex flex-grow">
    <!-- 左側導覽列 -->
    <aside class="w-64 bg-gray-900 text-white flex flex-col shadow-lg custom-scrollbar overflow-y-auto">
      <div class="p-6 text-2xl font-bold border-b border-gray-700">
        管理面板
      </div>
      <nav class="flex-grow p-4 space-y-2">
        <!-- 書籍管理 -->
        <div>
          <button @click="toggleMenu('books')" class="w-full flex items-center justify-between p-3 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out">
            <span class="font-medium">書籍</span>
            <svg :class="{'rotate-90': activeMenu === 'books'}" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
          <ul v-if="activeMenu === 'books'" class="ml-4 mt-1 space-y-1">
            <li><a @click="setActiveContent('queryBooks')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'queryBooks'}">查詢書籍</a></li>
            <li><a @click="setActiveContent('addBook')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'addBook'}">新增書籍</a></li>
          </ul>
        </div>

        <!-- 分類管理 -->
        <div>
          <button @click="toggleMenu('categories')" class="w-full flex items-center justify-between p-3 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out">
            <span class="font-medium">分類</span>
            <svg :class="{'rotate-90': activeMenu === 'categories'}" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
          <ul v-if="activeMenu === 'categories'" class="ml-4 mt-1 space-y-1">
            <li><a @click="setActiveContent('queryCategories')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'queryCategories'}">查詢分類</a></li>
            <li><a @click="setActiveContent('addCategory')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'addCategory'}">新增分類</a></li>
          </ul>
        </div>

        <!-- 作者管理 -->
        <div>
          <button @click="toggleMenu('authors')" class="w-full flex items-center justify-between p-3 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out">
            <span class="font-medium">作者</span>
            <svg :class="{'rotate-90': activeMenu === 'authors'}" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
          <ul v-if="activeMenu === 'authors'" class="ml-4 mt-1 space-y-1">
            <li><a @click="setActiveContent('queryAuthors')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'queryAuthors'}">查詢作者</a></li>
            <li><a @click="setActiveContent('addAuthor')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'addAuthor'}">新增作者</a></li>
          </ul>
        </div>

        <!-- 出版商管理 -->
        <div>
          <button @click="toggleMenu('publishers')" class="w-full flex items-center justify-between p-3 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out">
            <span class="font-medium">出版商</span>
            <svg :class="{'rotate-90': activeMenu === 'publishers'}" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
          <ul v-if="activeMenu === 'publishers'" class="ml-4 mt-1 space-y-1">
            <li><a @click="setActiveContent('queryPublishers')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'queryPublishers'}">查詢出版商</a></li>
            <li><a @click="setActiveContent('addPublisher')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'addPublisher'}">新增出版商</a></li>
          </ul>
        </div>

        <!-- 系列管理 -->
        <div>
          <button @click="toggleMenu('series')" class="w-full flex items-center justify-between p-3 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out">
            <span class="font-medium">系列</span>
            <svg :class="{'rotate-90': activeMenu === 'series'}" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
          <ul v-if="activeMenu === 'series'" class="ml-4 mt-1 space-y-1">
            <li><a @click="setActiveContent('querySeries')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'querySeries'}">查詢系列</a></li>
            <li><a @click="setActiveContent('addSeries')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'addSeries'}">新增系列</a></li>
          </ul>
        </div>

        <!-- 標籤管理 -->
        <div>
          <button @click="toggleMenu('tags')" class="w-full flex items-center justify-between p-3 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out">
            <span class="font-medium">標籤</span>
            <svg :class="{'rotate-90': activeMenu === 'tags'}" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
          <ul v-if="activeMenu === 'tags'" class="ml-4 mt-1 space-y-1">
            <li><a @click="setActiveContent('queryTags')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'queryTags'}">查詢標籤</a></li>
            <li><a @click="setActiveContent('addTag')" class="block p-2 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'addTag'}">新增標籤</a></li>
          </ul>
        </div>

        <!-- 會員管理 -->
        <div>
          <a @click="setActiveContent('memberManagement')" class="block p-3 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'memberManagement'}">會員管理</a>
        </div>

        <!-- 數據分析 -->
        <div>
          <a @click="setActiveContent('dataAnalysis')" class="block p-3 rounded-md hover:bg-gray-700 transition duration-150 ease-in-out cursor-pointer" :class="{'bg-gray-700': activeContent === 'dataAnalysis'}">數據分析</a>
        </div>
      </nav>
    </aside>

    <!-- 右側內容區 -->
    <main class="flex-grow p-8 bg-gray-100">
      <div class="bg-white rounded-lg shadow-md p-6 min-h-full">
        <!-- 內容標題 -->
        <h1 class="text-2xl font-bold mb-6 text-gray-800">{{ contentTitle }}</h1>

        <!-- 查詢書籍內容 -->
        <div v-if="activeContent === 'queryBooks'">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <!-- 主類別 -->
            <div>
              <label for="mainCategoryFilter" class="block text-sm font-medium text-gray-700">主類別</label>
              <select v-model="filters.mainCategoryId" id="mainCategoryFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" @change="searchBooks">
                <option :value="null">所有主類別</option>
                <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.categoryTitle }}</option>
              </select>
            </div>
            <!-- 次類別 -->
            <div>
              <label for="subCategoryFilter" class="block text-sm font-medium text-gray-700">次類別</label>
              <select v-model="filters.subCategoryId" id="subCategoryFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" @change="searchBooks">
                <option :value="null">所有次類別</option>
                <template v-for="cat in categories">
                  <option v-for="subCat in cat.categorySubs" :key="subCat.id" :value="subCat.id" v-if="filters.mainCategoryId === cat.id || filters.mainCategoryId === null">{{ subCat.categorySubTitle }}</option>
                </template>
              </select>
            </div>
            <!-- 出版年份 -->
            <div>
              <label for="publishYearFilter" class="block text-sm font-medium text-gray-700">出版年份</label>
              <input v-model.lazy="filters.publishYear" type="number" id="publishYearFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" @keyup.enter="searchBooks">
            </div>
            <!-- 作者模糊搜尋 -->
            <div>
              <label for="authorKeywordFilter" class="block text-sm font-medium text-gray-700">作者關鍵字</label>
              <input v-model.lazy="filters.authorKeyword" type="text" id="authorKeywordFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" @keyup.enter="searchBooks">
            </div>
            <!-- 出版商模糊搜尋 -->
            <div>
              <label for="publisherKeywordFilter" class="block text-sm font-medium text-gray-700">出版商關鍵字</label>
              <input v-model.lazy="filters.publisherKeyword" type="text" id="publisherKeywordFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" @keyup.enter="searchBooks">
            </div>
            <!-- 書名模糊搜尋 -->
            <div>
              <label for="bookTitleKeywordFilter" class="block text-sm font-medium text-gray-700">書名關鍵字</label>
              <input v-model.lazy="filters.bookTitleKeyword" type="text" id="bookTitleKeywordFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" @keyup.enter="searchBooks">
            </div>
          </div>
          <div class="mb-6">
            <label for="isbnSearch" class="block text-sm font-medium text-gray-700">ISBN 精確搜尋</label>
            <input v-model.lazy="filters.isbn" type="text" id="isbnSearch" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" @keyup.enter="searchBooks">
          </div>
          <button @click="searchBooks" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">執行搜尋</button>
          <button @click="clearAllFilters" class="ml-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">清除篩選</button>

          <!-- 書籍列表表格 -->
          <div class="mt-8 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">書名</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">系列</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">主分類</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">次分類</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">作者</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">出版年份</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">出版商</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ISBN</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">代表作</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">借閱狀況</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">操作</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">副本</th>
              </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
              <tr v-if="books.content.length === 0">
                <td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">無書籍資料</td>
              </tr>
              <tr v-for="book in books.content" :key="book.id">
                <td class="px-6 py-4 whitespace-nowrap">{{ book.id }}</td>
                <td class="px-6 py-4 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis">{{ book.title }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ book.seriesTitle || 'N/A' }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ book.mainCategoryTitle || 'N/A' }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ book.subCategoryTitle || 'N/A' }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ book.authors ? book.authors.join(', ') : '未知作者' }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ book.publishYear || 'N/A' }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ book.publisherName || 'N/A' }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ book.isbn }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ book.representative ? '是' : '否' }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ book.availableCopies }}/{{ book.totalCopies }}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <button @click="editBook(book.id)" class="text-indigo-600 hover:text-indigo-900 mr-2">編輯</button>
                  <button @click="confirmDeleteBook(book.id, book.title)" class="text-red-600 hover:text-red-900">刪除</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <button @click="viewCopies(book.id, book.title)" class="text-blue-600 hover:text-blue-900">查看副本</button>
                </td>
              </tr>
              </tbody>
            </table>
          </div>

          <!-- 分頁導航 -->
          <div v-if="books.totalPages > 1" class="mt-8 flex justify-center items-center space-x-2">
            <button @click="prevPage" :disabled="books.first" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out">
              上一頁
            </button>
            <span class="text-sm font-medium text-gray-700">
              頁數 {{ books.currentPage + 1 }} / {{ books.totalPages }}
            </span>
            <button @click="nextPage" :disabled="books.last" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out">
              下一頁
            </button>
          </div>

          <!-- 副本列表 -->
          <div v-if="currentBookIdForCopies" class="mt-8">
            <h3 class="text-xl font-bold mb-4 text-gray-800">{{ currentBookCopies.length > 0 ? '副本列表' : '暫無副本' }}</h3>
            <h4 class="text-xl font-bold mb-4 text-gray-800">ID:{{ currentBookIdForCopies }} | 書名:{{currentBookTitle}}</h4>
            <table class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">唯一碼</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">目前借閱者</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">借閱日</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">到期日</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">歸還日</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">操作</th>
                <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">記錄</th>
              </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="copy in currentBookCopies" :key="copy.id">
                <td class="px-6 py-4 whitespace-nowrap">{{ copy.id }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ copy.uniqueCode }}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span :class="{'text-green-600': copy.status === 'A', 'text-yellow-600': copy.status === 'L', 'text-blue-600': copy.status === 'R'}">
                    {{ copy.statusDisplay }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">{{ copy.currentBorrowerAccount || '無' }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ formatDateTime(copy.loanDate) }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ formatDate(copy.dueDate) }}</td>
                <td class="px-6 py-4 whitespace-nowrap">{{ formatDateTime(copy.returnDate) }}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <button @click="editBookCopy(copy.id)" class="text-indigo-600 hover:text-indigo-900 mr-2">編輯</button>
                  <button @click="confirmDeleteBookCopy(copy.id, copy.uniqueCode)" class="text-red-600 hover:text-red-900 mr-2">刪除</button>
                  <button v-if="copy.status === 'L'" @click="forceReturn(copy.id, copy.loanId, copy.userId)" class="text-green-600 hover:text-green-900 mr-2">強制歸還</button>
                  <button v-if="copy.status === 'A'" @click="forceCheckout(copy.id)" class="text-blue-600 hover:text-blue-900">強制借出</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <button @click="viewLoanRecord(copy.id)" class="text-purple-600 hover:text-purple-900 mr-2">借閱</button>
                  <button @click="viewReservationRecord(copy.id)" class="text-purple-600 hover:text-purple-900">預約</button>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 其他管理內容 -->
        <div v-else class="text-gray-600">
          <p>這是 {{ contentTitle }} 的內容區塊。</p>
          <p>功能待實作...</p>
        </div>
      </div>
    </main>

    <!-- 強制借出/歸還的輸入彈窗 -->
    <div v-if="showForceCheckoutModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl w-96">
        <h3 class="text-lg font-bold mb-4">強制借出副本</h3>
        <p class="mb-4">請輸入借閱者的帳號：</p>
        <input v-model="forceCheckoutAccount" type="text" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 mb-4">
        <div class="flex justify-end space-x-4">
          <button @click="cancelForceCheckout" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">取消</button>
          <button @click="submitForceCheckout" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">確認借出</button>
        </div>
      </div>
    </div>

    <!-- 刪除確認彈窗 -->
    <div v-if="showDeleteConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl w-96">
        <h3 class="text-lg font-bold mb-4">確認刪除</h3>
        <p class="mb-4">您確定要刪除 <span class="font-semibold text-red-600">{{ deleteConfirmMessage }}</span> 嗎？此操作不可逆。</p>
        <div class="flex justify-end space-x-4">
          <button @click="cancelDelete" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">取消</button>
          <button @click="executeDelete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">確認刪除</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, watch } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'

const router = useRouter()

// 響應式數據
const activeMenu = ref('books')
const activeContent = ref('queryBooks')
const contentTitle = ref('查詢書籍')
const categories = ref([])

// 查詢書籍篩選條件
const filters = reactive({
  mainCategoryId: null,
  subCategoryId: null,
  publishYear: null,
  authorKeyword: null,
  publisherKeyword: null,
  bookTitleKeyword: null,
  isbn: null
})

// 書籍列表分頁數據
const books = reactive({
  content: [],
  totalPages: 0,
  currentPage: 0,
  pageSize: 10,
  totalElements: 0,
  last: true,
  first: true
})

// 副本列表數據
const currentBookCopies = ref([])
const currentBookIdForCopies = ref(null)
const currentBookTitle = ref(null)
const currentBorrowerAccount = ref(null)

const loading = ref(false)
const error = ref(null)

// 刪除確認彈窗相關
const showDeleteConfirmModal = ref(false)
const deleteConfirmMessage = ref('')
const deleteTargetType = ref(null)
const deleteTargetId = ref(null)

// 強制借出/歸還彈窗相關
const showForceCheckoutModal = ref(false)
const forceCheckoutCopyId = ref(null)
const forceCheckoutAccount = ref(null)

// 方法定義
const toggleMenu = (menu) => {
  activeMenu.value = activeMenu.value === menu ? null : menu
}

const setActiveContent = (content) => {
  activeContent.value = content
  switch (content) {
    case 'queryBooks':
      contentTitle.value = '查詢書籍'
      searchBooks() // 當前頁面重新載入
      break
    case 'addBook':
      contentTitle.value = '新增書籍'
      router.push('/admin/adminCreateBook')
      break
    case 'memberManagement':
      contentTitle.value = '會員管理'
      break
    default:
      contentTitle.value = '未知內容'
  }
}

const fetchCategories = async () => {
  try {
    const response = await axios.get('/api/categories')
    categories.value = response.data
  } catch (error) {
    console.error('Error fetching categories:', error)
    error.value = '無法載入分類資料。'
  }
}

const searchBooks = async () => {
  loading.value = true
  error.value = null

  const params = new URLSearchParams()
  params.append('page', books.currentPage)
  params.append('size', books.pageSize)

  if (filters.keyword) params.append('keyword', filters.keyword)
  if (filters.mainCategoryId) params.append('mainCategoryId', filters.mainCategoryId)
  if (filters.subCategoryId) params.append('subCategoryId', filters.subCategoryId)
  if (filters.publishYear) params.append('publishYear', filters.publishYear)
  if (filters.authorKeyword) params.append('authorKeyword', filters.authorKeyword)
  if (filters.publisherKeyword) params.append('publisherKeyword', filters.publisherKeyword)
  if (filters.bookTitleKeyword) params.append('bookTitleKeyword', filters.bookTitleKeyword)
  if (filters.isbn) params.append('isbn', filters.isbn)

  try {
    const response = await axios.get(`/api/admin/books?${params.toString()}`)
    Object.assign(books, response.data.bookPage)
    console.log(books.content)
  } catch (err) {
    console.error('Error fetching books:', err)
    error.value = '無法獲取書籍列表，請稍後再試。'
  } finally {
    loading.value = false
  }
}

const clearAllFilters = () => {
  Object.assign(filters, {
    mainCategoryId: null,
    subCategoryId: null,
    publishYear: null,
    authorKeyword: null,
    publisherKeyword: null,
    bookTitleKeyword: null,
    isbn: null
  })
  books.currentPage = 0
  searchBooks()
}

const nextPage = () => {
  if (!books.last) {
    books.currentPage++
    searchBooks()
  }
}

const prevPage = () => {
  if (!books.first) {
    books.currentPage--
    searchBooks()
  }
}

const editBook = (bookId) => {
  console.log(`編輯書籍 ID: ${bookId} (導向 bookUpdate.html)`)
}

const confirmDeleteBook = (bookId, bookTitle) => {
  showDeleteConfirmModal.value = true
  deleteConfirmMessage.value = `書籍 "${bookTitle}" (ID: ${bookId})`
  deleteTargetType.value = 'book'
  deleteTargetId.value = bookId
}

const executeDelete = () => {
  if (deleteTargetType.value === 'book') {
    deleteBook(deleteTargetId.value)
  } else if (deleteTargetType.value === 'bookCopy') {
    deleteBookCopy(deleteTargetId.value)
  }
  cancelDelete()
}

const cancelDelete = () => {
  showDeleteConfirmModal.value = false
  deleteConfirmMessage.value = ''
  deleteTargetType.value = null
  deleteTargetId.value = null
}

const deleteBook = async (bookId) => {
  console.log(`正在刪除書籍 ID: ${bookId}`)
  try {
    const response = await axios.delete(`/api/admin/books/${bookId}`)
    alert('書籍刪除成功！')
    searchBooks()
    currentBookCopies.value = []
  } catch (err) {
    console.error('Error deleting book:', err)
    alert(`刪除書籍失敗: ${err.message}`)
  }
}

const viewCopies = async (bookId, title) => {
  loading.value = true
  error.value = null
  currentBookIdForCopies.value = bookId
  currentBookTitle.value = title
  currentBookCopies.value = []

  try {
    const response = await axios.get(`/api/admin/books/${bookId}/copies`)
    currentBookCopies.value = response.data.map(copy => {
      let statusDisplay = ''
      switch (copy.status) {
        case 'A': statusDisplay = '可借閱'; break
        case 'L': statusDisplay = '已借出'; break
        case 'R': statusDisplay = '已預約'; break
        default: statusDisplay = copy.status
      }
      return { ...copy, statusDisplay }
    })
  } catch (err) {
    console.error('Error fetching book copies:', err)
    error.value = '無法獲取書籍副本資料，請稍後再試。'
  } finally {
    loading.value = false
  }
}

const editBookCopy = (copyId) => {
  console.log(`編輯書籍副本 ID: ${copyId}`)
}

const confirmDeleteBookCopy = (copyId, uniqueCode) => {
  showDeleteConfirmModal.value = true
  deleteConfirmMessage.value = `書籍副本 "${uniqueCode}" (ID: ${copyId})`
  deleteTargetType.value = 'bookCopy'
  deleteTargetId.value = copyId
}

const deleteBookCopy = async (copyId) => {
  console.log(`正在刪除書籍副本 ID: ${copyId}`)
  try {
    const response = await axios.delete(`/api/admin/book-copies/${copyId}`)
    alert('書籍副本刪除成功！')
    viewCopies(currentBookIdForCopies.value)
  } catch (err) {
    console.error('Error deleting book copy:', err)
    alert(`刪除書籍副本失敗: ${err.message}`)
  }
}

const forceReturn = async (copyId, loanId, userId) => {
  console.log(`強制歸還書籍副本 ID: ${copyId}`)
  try {
    const response = await axios.post(`/api/admin/book-copies/force-return`, {
      loanId: loanId,
      userId: userId
    })
    alert('強制歸還成功！')
    viewCopies(currentBookIdForCopies.value)
  } catch (err) {
    console.error('Error force returning book copy:', err)
    alert(`強制歸還失敗: ${err.message}`)
  }
}

const forceCheckout = (copyId) => {
  showForceCheckoutModal.value = true
  forceCheckoutCopyId.value = copyId
  forceCheckoutAccount.value = ''
}

const cancelForceCheckout = () => {
  showForceCheckoutModal.value = false
  forceCheckoutCopyId.value = null
  forceCheckoutAccount.value = null
}

const submitForceCheckout = async () => {
  if (!forceCheckoutAccount.value) {
    alert('請輸入借閱者帳號！')
    return
  }
  console.log(`強制借出書籍副本 ID: ${forceCheckoutCopyId.value} 給帳號: ${forceCheckoutAccount.value}`)
  try {
    const response = await axios.post(`/api/admin/book-copies/${forceCheckoutCopyId.value}/force-checkout`, {
      borrowerAccount: forceCheckoutAccount.value
    })
    alert('強制借出成功！')
    cancelForceCheckout()
    viewCopies(currentBookIdForCopies.value)
  } catch (err) {
    console.error('Error force checking out book copy:', err)
    alert(`強制借出失敗: ${err.message}`)
  }
}

const viewLoanRecord = (copyId) => {
  console.log(`查看副本 ID: ${copyId} 的借閱記錄 (導向 loanRecord.html)`)
}

const viewReservationRecord = (copyId) => {
  console.log(`查看副本 ID: ${copyId} 的預約記錄 (導向 reservationRecord.html)`)
}

const formatDateTime = (dateTime) => {
  if (!dateTime) return '無'
  const date = new Date(dateTime)
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  const hours = String(date.getHours()).padStart(2, '0')
  const minutes = String(date.getMinutes()).padStart(2, '0')
  return `${year}-${month}-${day} ${hours}:${minutes}`
}

const formatDate = (date) => {
  if (!date) return '無'
  const dateObj = new Date(date)
  const year = dateObj.getFullYear()
  const month = String(dateObj.getMonth() + 1).padStart(2, '0')
  const day = String(dateObj.getDate()).padStart(2, '0')
  return `${year}-${month}-${day}`
}

// 監聽器
watch(() => filters.mainCategoryId, (newVal, oldVal) => {
  if (newVal !== oldVal) {
    filters.subCategoryId = null
  }
})

// 生命週期鉤子
onMounted(() => {
  fetchCategories()
  searchBooks()
})
</script>

<style scoped>
/* 自定義滾動條樣式 */
.custom-scrollbar::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
.custom-scrollbar::-webkit-scrollbar-track {
  background: #2d3748; /* bg-gray-800 */
  border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
  background: #4a5568; /* bg-gray-700 */
  border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: #6b7280; /* bg-gray-600 */
}
</style>
