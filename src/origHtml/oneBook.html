<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>書籍詳情 - 圖書館</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入外部 CSS 檔案 -->
    <link rel="stylesheet" href="/css/style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* 狀態點樣式 */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-available {
            background-color: #10b981; /* 綠色 - 可借閱 */
        }

        .status-borrowed {
            background-color: #ef4444; /* 紅色 - 已借出 */
        }

        .status-reserved {
            background-color: #f59e0b; /* 黃色 - 已預約 */
        }

        .status-other {
            background-color: #6b7280; /* 灰色 - 其他狀態 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<div id="app" class="flex-grow flex flex-col">
    <!-- 導覽列 (header) -->
    <header class="bg-indigo-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex items-center justify-between">
            <a href="/" class="text-2xl font-bold rounded-md px-3 py-2 hover:bg-indigo-600 transition">日比野線上圖書館 V2</a>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input type="text" placeholder="搜尋書籍..." class="py-2 px-4 rounded-md text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                    <button class="absolute right-0 top-0 h-full px-3 rounded-r-md bg-indigo-600 hover:bg-indigo-500 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-white">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                    </button>
                </div>
                <!-- 個人頁面 (有登入才會顯示) -->
                <a v-if="isLoggedIn" :href="'/html/myPage'" class="hover:text-indigo-200 transition-colors">個人頁面</a>
                <!-- 管理者頁面 -->
                <a href="/html/admin/adminPanel" class="hover:underline">管理者頁面</a>
                <!-- 登入/登出按鈕 -->
                <button @click="isLoggedIn ? logout() : showLoginModal()"
                        class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-all duration-300 flex items-center space-x-2">
                    <svg v-if="!isLoggedIn" class="lucide lucide-log-in w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                    <svg v-else class="lucide lucide-log-out w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 17 22 12 17 7"/><line x1="22" x2="10" y1="12" y2="12"/></svg>
                    <span>{{ isLoggedIn ? '登出' : '登入' }}</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主要內容容器 -->
    <main class="container mx-auto p-4 md:p-8 flex-grow">
        <!-- 導航區 -->
        <div class="mb-6">
            <button @click="goBack"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-sm transition-colors duration-200 flex items-center space-x-2">
                <svg class="lucide lucide-arrow-left w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m12 19-7-7 7-7"/>
                    <path d="M19 12H5"/>
                </svg>
                <span>返回上一頁</span>
            </button>
        </div>

        <!-- 加載中/錯誤訊息 -->
        <div v-if="loading" class="flex items-center justify-center p-12 bg-white rounded-lg shadow-md">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>加載中...</span>
        </div>

        <div v-if="error" class="p-4 bg-red-100 text-red-700 rounded-lg shadow-md mb-6">
            {{ error }}
        </div>

        <!-- 書籍詳情內容 -->
        <div v-if="!loading && !error" class="flex flex-col space-y-6">

            <!-- 上框：書籍資訊 -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 shadow-sm flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-6">
                <!-- 書籍封面，w-48 和 h-64 控制寬高，md:w-64 md:h-80 是在中等螢幕以上的寬高。 h-96 是極限，傻眼==-->
                <div class="flex-shrink-0 w-48 h-64 md:w-80 md:h-96 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center text-gray-400 text-sm shadow-md">
                    <img :src="bookDetails.imageUrl || 'https://placehold.co/256x320/e2e8f0/64748b?text=無圖片'"
                         :alt="bookDetails.title"
                         class="h-full w-auto object-contain"
                         onerror="this.onerror=null;this.src='https://placehold.co/256x320/e2e8f0/64748b?text=無圖片';" />
                </div>

                <!-- 書本詳細資訊 -->
                <div class="flex-grow text-center md:text-left">
                    <h1 class="text-3xl font-bold text-gray-900 mb-3">{{ bookDetails.title || '載入中...' }}</h1>
                    <div v-if="bookDetails.id">
                        <p class="text-xl text-gray-700 mb-2"><strong>作者:</strong> {{ bookDetails.authors ? bookDetails.authors.join(', ') : '未知作者' }}</p>
                        <p class="text-lg text-gray-600 mb-2"><strong>主類別:</strong> {{ bookDetails.mainCategoryTitle || '未知' }}</p>
                        <p class="text-lg text-gray-600 mb-2"><strong>次類別:</strong> {{ bookDetails.subCategoryTitle || '未知' }}</p>
                        <p class="text-lg text-gray-600 mb-2"><strong>出版商:</strong> {{ bookDetails.publisher || '未知出版商' }}</p>
                        <p class="text-lg text-gray-600 mb-2"><strong>出版年份:</strong> {{ bookDetails.publishYear || 'N/A' }}</p>
                        <p class="text-lg text-gray-600 mb-4"><strong>ISBN:</strong> {{ bookDetails.isbn || 'N/A' }}</p>

                        <!-- 系列資訊 -->
                        <div v-if="bookDetails.seriesTitle" class="mb-4">
                            <p class="text-lg text-gray-600"><strong>系列:</strong> {{ bookDetails.seriesTitle }}</p>
                        </div>

                        <!-- 標籤 -->
                        <div class="mb-4">
                            <p class="text-lg text-gray-600 mb-2"><strong>標籤:</strong></p>
                            <div class="flex flex-wrap gap-2">
                                <template v-if="bookDetails.tags && bookDetails.tags.length > 0">
                                    <span v-for="tag in bookDetails.tags" :key="tag.id"
                                          class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium cursor-pointer hover:bg-indigo-200 transition">
                                        {{ tag }}
                                    </span>
                                </template>
                                <template v-else>
                                    <span class="px-3 py-1 bg-gray-200 text-gray-500 text-sm rounded-full">無</span>
                                </template>
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-800 mb-3">書籍簡介</h3>
                        <p class="text-gray-600 leading-relaxed mb-4">{{ bookDetails.description || '暫無簡介。' }}</p>

                        <p class="text-lg text-gray-800 font-semibold">
                            可借閱: <span class="text-indigo-600">{{ bookDetails.availableCopies || 0 }}</span> / 總數: {{ bookDetails.totalCopies || '尚未引進副本' }}
                        </p>
                    </div>
                    <div v-else class="text-gray-500 text-center py-10">
                        載入書籍資訊中...
                    </div>
                </div>
            </div>

            <!-- 下框：借閱狀況 -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 shadow-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">借閱狀況</h3>
                <div v-if="bookCopies.length > 0">
                    <ul class="space-y-3">
                        <li v-for="copy in bookCopies" :key="copy.id" class="flex items-center text-gray-700">
                            <span :class="['status-dot', {
                                'status-available': copy.statusDescription === '可借閱',
                                'status-borrowed': copy.statusDescription === '已借出',
                                'status-reserved': copy.statusDescription === '已預約',
                                'status-other': !['可借閱', '已借出', '已預約'].includes(copy.statusDescription)
                            }]"></span>
                            <span>書籍編號: <strong>{{ copy.uniqueCode }}</strong> - 狀態: {{ copy.statusDescription }}</span>
                            <span v-if="copy.statusDescription === '已借出' && copy.dueDate" class="ml-4 text-sm text-red-600">
                                (到期日: {{ formatDate(copy.dueDate) }})
                            </span>
                        </li>
                    </ul>
                </div>
                <div v-else class="text-gray-500">
                    無借閱副本資訊。
                </div>

                <!-- 借閱按鈕 -->
                <div class="mt-6 text-right">
                    <button @click="borrowBook(bookDetails.id)"
                            v-if="(bookDetails.availableCopies || 0) > 0 && isLoggedIn"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-5 rounded-md shadow-lg transition-all duration-200">
                        借閱此書 (剩餘: {{ bookDetails.availableCopies || 0 }})
                    </button>
                    <button v-else-if="!isLoggedIn"
                            @click="showLoginModal()"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-md shadow-lg transition-all duration-200">
                        登入後借閱
                    </button>
                    <button v-else
                            class="bg-gray-400 text-white font-semibold py-2 px-5 rounded-md cursor-not-allowed">
                        暫無可借閱副本
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 尾部 (footer) -->
    <footer class="bg-gray-800 text-white p-6 mt-8">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; 2025 我的圖書館. 版權所有.</p>
            <div class="mt-2 space-x-4">
                <a href="#" class="hover:underline">關於我們</a>
                <a href="#" class="hover:underline">聯絡我們</a>
                <a href="#" class="hover:underline">隱私政策</a>
            </div>
        </div>
    </footer>


    <!-- 登入模態框 -->
    <div v-if="showLoginModalFlag" class="modal-overlay" @click.self="hideLoginModal">
        <div class="modal-content">
            <button class="close-button" @click="hideLoginModal">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">登入</h2>
            <form @submit.prevent="handleLogin">
                <div class="mb-4">
                    <label for="account" class="block text-gray-700 text-sm font-bold mb-2">帳號:</label>
                    <input type="text" id="account" v-model="loginForm.account"
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                           required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">密碼:</label>
                    <input type="password" id="password" v-model="loginForm.password"
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
                           required>
                </div>
                <div v-if="loginError" class="text-red-500 text-sm mb-4 text-center">{{ loginError }}</div>
                <div class="flex items-center justify-between">
                    <button type="submit"
                            class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline w-full transition-colors duration-200">
                        登入
                    </button>
                </div>
            </form>
            <div class="mt-4 text-center">
                <a href="/html/register" class="text-indigo-600 hover:text-indigo-800 text-sm font-semibold">
                    還沒有帳號？加入會員
                </a>
            </div>
        </div>
    </div>

    <!-- 借閱確認模態框 -->
    <div v-if="showBorrowConfirmModal" class="modal-overlay" @click.self="hideBorrowConfirmModal">
        <div class="modal-content">
            <button class="close-button" @click="hideBorrowConfirmModal">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">確認借閱</h2>
            <p class="text-gray-700 text-center mb-6">您確定要借閱 **{{ borrowingBookTitle }}** 嗎？</p>
            <div class="flex justify-around space-x-4">
                <button @click="confirmBorrow"
                        class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-md transition-colors duration-200">
                    確定
                </button>
                <button @click="hideBorrowConfirmModal"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition-colors duration-200">
                    取消
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            // 響應式數據
            const bookDetails = ref({});
            const bookCopies = ref([]);
            const loading = ref(false);
            const error = ref(null);

            // 登入相關狀態
            const showLoginModalFlag = ref(false);
            const loginForm = ref({ account: '', password: '' });
            const loginError = ref('');
            const isLoggedIn = ref(false);
            const currentUserId = ref(null); // 從 JWT 獲取的使用者 ID
            const currentUserRole = ref(null); // 從 JWT 獲取的使用者角色
            const currentUsername = ref(null); // 新增：儲存使用者帳號


            // 借閱確認模態框狀態
            const showBorrowConfirmModal = ref(false);
            const borrowingBookId = ref(null);
            const borrowingBookTitle = ref('');

            // --- Axios Interceptor (自動添加 JWT) ---
            axios.interceptors.request.use(
                config => {
                    const token = localStorage.getItem('jwtToken');
                    if (token) {
                        config.headers.Authorization = `Bearer ${token}`;
                    }
                    return config;
                },
                error => {
                    return Promise.reject(error);
                }
            );

            /*
            // 檢查初始登入狀態
            const checkLoginStatus = () => {
                const token = localStorage.getItem('jwtToken');
                const storedUserId = localStorage.getItem('userId');
                const storedUserRole = localStorage.getItem('userRole');

                if (token && storedUserId && storedUserRole) {
                    isLoggedIn.value = true;
                    currentUserId.value = parseInt(storedUserId);
                    currentUserRole.value = storedUserRole;
                    // 可以選擇驗證 JWT 的有效性，但通常交給後端處理
                } else {
                    isLoggedIn.value = false;
                    currentUserId.value = null;
                    currentUserRole.value = null;
                }
            };
             */
            // --- 核心修改：檢查登入狀態的邏輯 ---
            /** TODO myPage index 的 jwt 解析方式略不同，待統一改 jose **/
            const checkLoginStatus = () => {
                // 現在只需檢查 token 是否存在及其有效性
                const token = localStorage.getItem('jwtToken');
                if (token) {
                    try {
                        // 1. 解碼 JWT 的 Payload 部分
                        const payloadBase64 = token.split('.')[1];
                        const base64 = payloadBase64.replace(/-/g, '+').replace(/_/g, '/'); // 增強解碼，處理 URL 安全的 Base64
                        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        }).join(''));
                        const decodedPayload = JSON.parse(jsonPayload);
                        // 2. 檢查 token 是否過期 (exp 是標準的過期時間聲明，單位是秒)
                        if (decodedPayload.exp * 1000 < Date.now()) {
                            // JWT 的 exp 欄位是以「秒」為單位的 UNIX 時間戳，而 JavaScript 的 Date.now() 回傳的是「毫秒」。
                            // 所以這裡 decodedPayload.exp \* 1000 是把秒轉成毫秒，才能和 Date.now() 正確比較。
                            // 是為了在頁面操作時即時判斷 JWT 是否已過期，避免使用已失效的 token 發送 API 請求。
                            console.log("Token 已過期。");
                            // 如果 token 過期，只移除 token 並重設狀態，不呼叫 logout() 避免無限循環
                            localStorage.removeItem('jwtToken');
                            isLoggedIn.value = false;
                            currentUserId.value = null;
                            currentUserRole.value = null;
                            currentUsername.value = null;
                            return;
                        }
                        // 3. 從解碼後的 payload 中取得資訊並更新狀態
                        isLoggedIn.value = true;
                        currentUserId.value = parseInt(decodedPayload.sub); // 'sub' 是使用者 ID
                        currentUserRole.value = decodedPayload.role;       // 'role' 是自訂聲明
                        currentUsername.value = decodedPayload.username; // 'username' 也是自訂聲明

                    } catch (e) {
                        console.error("無法解碼 JWT:", e);
                        // 如果 token 格式錯誤，同樣只移除 token 並重設狀態
                        localStorage.removeItem('jwtToken');
                        isLoggedIn.value = false;
                        currentUserId.value = null;
                        currentUserRole.value = null;
                        currentUsername.value = null;
                    }
                } else {
                    // 如果沒有 token，就是未登入狀態
                    isLoggedIn.value = false;
                    currentUserId.value = null;
                    currentUserRole.value = null;
                    currentUsername.value = null;
                }
            };


            // 顯示登入模態框
            const showLoginModal = () => {
                console.log('點擊登入按鈕 - 顯示模態框'); // 加入這行來調試
                showLoginModalFlag.value = true;
                loginError.value = ''; // 清除之前的錯誤訊息
                loginForm.value = { account: '', password: '' }; // 重置表單
            };

            // 隱藏登入模態框
            const hideLoginModal = () => {
                showLoginModalFlag.value = false;
            };

            // 處理登入請求
            const handleLogin = async () => {
                loginError.value = ''; // 清除錯誤訊息
                try {
                    const response = await axios.post('/api/auth/login', loginForm.value);
                    //const { jwt, userId, role } = response.data;
                    console.log(response.data);
                    const { jwtToken } = response.data;

                    // 儲存 JWT 和使用者資訊到 localStorage
                    localStorage.setItem('jwtToken', jwtToken);
                    //localStorage.setItem('userId', userId);
                    //localStorage.setItem('userRole', role);

                    alert('登入成功！');
                    // 【修正】登入成功後，直接重新整理頁面
                    window.location.reload();

                } catch (error) {
                    console.error('登入失敗:', error);
                    if (error.response && error.response.status === 401) {
                        loginError.value = '帳號或密碼錯誤，請重試。';
                    } else {
                        loginError.value = '登入時發生錯誤，請稍後再試。';
                    }
                }
            };

            // 處理登出
            const logout = () => {
                localStorage.removeItem('jwtToken');
                //localStorage.removeItem('userId');
                //localStorage.removeItem('userRole');
                checkLoginStatus(); // 更新登入狀態
                alert('已登出。');
                // 登出後可以導向首頁或刷新當前頁面
                window.location.href = '/'; // 回到根目錄首頁
            };


            // 從 URL 獲取書籍 ID
            const getBookIdFromUrl = () => {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            };


            // 獲取書籍詳情
            const fetchBookDetails = async (bookId) => {
                if (!bookId) {
                    error.value = '無效的書籍 ID';
                    return;
                }

                loading.value = true;
                error.value = null;

                try {
                    const response = await fetch(`/api/books/${bookId}`);
                    if (!response.ok) {
                        throw new Error(`無法獲取書籍詳情: ${response.status}`);
                    }

                    const data = await response.json();
                    bookDetails.value = data;
                    bookCopies.value = data.bookCopies || [];

                    console.log('成功獲取書籍詳情:', data);
                } catch (err) {
                    console.error('獲取書籍詳情失敗:', err);
                    error.value = '無法獲取書籍詳情，請稍後再試。';
                } finally {
                    loading.value = false;
                }
            };


            // 借閱書籍按鈕點擊事件 (顯示確認模態框)
            const borrowBook = (bookId) => { // bookId 參數就是按鈕點擊時傳入的 bookDetails.id
                if (!isLoggedIn.value) {
                    alert('請先登入才能借閱書籍！');
                    showLoginModal();
                    return;
                }
                // 設定要借閱的書籍ID和標題，然後顯示模態框
                borrowingBookId.value = bookId;
                borrowingBookTitle.value = bookDetails.value.title; // 從當前詳情頁面的書籍標題獲取

                // 額外日誌，用於調試
                console.log('--- borrowBook 函數內部調試 ---');
                console.log('傳入的 bookId 參數:', bookId);
                console.log('bookDetails.value.id:', bookDetails.value.id);
                console.log('bookDetails.value.title:', bookDetails.value.title);
                console.log('設定 borrowingBookId.value 為:', borrowingBookId.value);
                console.log('設定 borrowingBookTitle.value 為:', borrowingBookTitle.value);
                showBorrowConfirmModal.value = true;
            };

            // 隱藏借閱確認模態框
            const hideBorrowConfirmModal = () => {
                showBorrowConfirmModal.value = false;
                borrowingBookId.value = null;
                borrowingBookTitle.value = '';
            };

            // 確定借閱 (發送請求到後端)
            const confirmBorrow = async () => {
                if (currentUserId.value === null) {
                    alert('無法獲取使用者ID，請重新登入。');
                    showLoginModal();
                    return;
                }

                try {
                    const response = await axios.post('/api/loans/borrow0822', {
                        bookId: borrowingBookId.value,
                        //userId: currentUserId.value
                    });

                    if (response.data.success) {
                        alert(`借閱成功！\n書籍副本唯一碼: ${response.data.borrowedBookUniqueCode}\n借閱記錄ID: ${response.data.loanId}`);
                        // 借閱成功後，刷新書籍詳情以更新可借閱數量和副本狀態
                        await fetchBookDetails(borrowingBookId.value);
                    } else {
                        alert(`借閱失敗: ${response.data.message}`);
                        await fetchBookDetails(borrowingBookId.value); // 不知為何沒用
                    }
                } catch (error) {
                    console.error('借閱請求失敗:', error);
                    // 更詳細的錯誤日誌
                    console.error('API 請求錯誤詳情:', error.response);
                    console.error('嘗試借閱的書籍 ID:', borrowingBookId.value);
                    console.error('嘗試借閱的書籍標題:', borrowingBookTitle.value);
                    if (error.response && error.response.data && error.response.data.message) {
                        alert(`借閱失敗: ${error.response.data.message}`);
                    } else {
                        alert('借閱時發生錯誤，請稍後再試。');
                    }
                } finally {
                    // 無論成功或失敗，最後都隱藏模態框並清除狀態
                    hideBorrowConfirmModal();
                }
            };


            // 返回上一頁
            const goBack = () => {
                if (document.referrer && document.referrer.includes(window.location.origin)) {
                    window.history.back();
                } else {
                    window.location.href = '/bookQuery';
                }
            };

            // 重定向到登入頁面
            const redirectToLogin = () => {
                window.location.href = '/index';
            };

            // 格式化日期
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-TW');
            };

            // 生命週期鉤子
            onMounted(() => {
                checkLoginStatus(); // 檢查登入狀態
                const bookId = getBookIdFromUrl();
                if (bookId) {
                    fetchBookDetails(bookId);
                } else {
                    error.value = '未提供書籍 ID';
                }
            });

            return {
                bookDetails,
                bookCopies,
                loading,
                error,
                goBack,
                formatDate,

                // 登入相關
                showLoginModalFlag,
                loginForm,
                loginError,
                isLoggedIn,
                currentUserId,
                currentUserRole,
                showLoginModal,
                hideLoginModal,
                handleLogin,
                logout,

                // 借閱確認模態框
                showBorrowConfirmModal,
                borrowingBookTitle,
                hideBorrowConfirmModal,
                confirmBorrow,
                borrowBook, // 現在這個函數會觸發模態框

                redirectToLogin
            };
        }
    }).mount('#app');
</script>

</body>
</html>
