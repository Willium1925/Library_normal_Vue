<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>圖書館首頁</title>
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue.js 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Axios CDN -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- 引入外部 CSS 檔案 -->
  <link rel="stylesheet" href="/css/style.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    /* 自定義RWD樣式 */
    @media (max-width: 1023px) {
      .sidebar {
        width: 100% !important;
        min-width: 100% !important;
      }
    }
    @media (min-width: 1024px) {
      .sidebar {
        width: 300px !important;
        min-width: 300px !important;
      }
    }
    /* 隱藏滾動條但保持滾動功能 */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    /* Easter Egg 樣式 */
    .easter-egg-gradient {
      background: linear-gradient(90deg, #facc15 0%, #facc15 100%);
      background-size: 0% 100%;
      background-repeat: no-repeat;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      transition: background-size 1.5s linear;
      display: inline-block;
    }
    .easter-egg-gradient.easter-egg-animate {
      background-size: 100% 100%;
    }

  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<div id="app" class="flex-grow flex flex-col">
  <!-- 導覽列 (header) -->
  <header class="bg-indigo-700 text-white p-4 shadow-md">
    <div class="container mx-auto flex items-center justify-between">
      <!--<a href="/" class="text-2xl font-bold rounded-md px-3 py-2 hover:text-indigo-200">日比野線上圖書館 V2</a>-->
      <!--<a href="/"
         class="text-2xl font-bold rounded-md px-3 py-2 hover:text-indigo-200"
         @mouseenter="startEasterEgg"
         @mouseleave="cancelEasterEgg"
         @click="easterEggActive ? goToEasterEgg() : null">
        {{ easterEggActive ? '日比野線上圖書館 V3' : '日比野線上圖書館 V2' }}
      </a>-->
      <a class="text-2xl font-bold rounded-md px-3 py-2 hover:text-indigo-200 relative overflow-hidden"
         @mouseenter="startEasterEgg"
         @mouseleave="cancelEasterEgg"
         @click="goToEasterEgg">
        <span v-if="easterEggActive" class="easter-egg-gradient">日比野線上圖書館 V3</span>
        <span v-else>日比野線上圖書館 V2</span>
      </a>
      <div class="flex items-center space-x-4">
        <div class="relative">
          <input type="text" placeholder="搜尋書籍..." class="py-2 px-4 rounded-md text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-300">
          <button class="absolute right-0 top-0 h-full px-3 rounded-r-md bg-indigo-600 hover:bg-indigo-500 transition">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-white">
              <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
          </button>
        </div>
        <!-- 個人頁面 (有登入才會顯示) -->
        <!-- <a href="#" class="hover:underline">個人頁面</a> -->
        <a v-if="isLoggedIn" :href="'/html/myPage'" class="hover:text-indigo-200 transition-transform transition-colors duration-200 origin-bottom">個人頁面</a>        <!-- 管理者頁面，導向 html/admin/adminPanel.html-->
        <a href="/html/admin/adminPanel" class="hover:text-indigo-200">管理者頁面</a>
        <!-- 登入/登出按鈕 -->
        <button @click="isLoggedIn ? logout() : showLoginModal()"
                class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-all duration-300 flex items-center space-x-2">
          <svg v-if="!isLoggedIn" class="lucide lucide-log-in w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
          <svg v-else class="lucide lucide-log-out w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 17 22 12 17 7"/><line x1="22" x2="10" y1="12" y2="12"/></svg>
          <span>{{ isLoggedIn ? '登出' : '登入' }}</span>
        </button>
      </div>
    </div>
  </header>

  <!-- 主要內容區塊 -->
  <main class="container mx-auto p-8 flex-grow flex flex-col gap-8">

    <!-- 精選推薦（圖片輪播牆） -->
    <section class="bg-white rounded-lg shadow-md p-6 relative overflow-hidden">
      <h2 class="text-xl font-bold mb-4 text-gray-800">精選推薦</h2>
      <div class="relative w-full h-64 overflow-hidden rounded-lg">
        <img :src="carouselImages[currentSlideIndex]" alt="Carousel Image" class="w-full h-full object-cover transition-opacity duration-500" :class="{'opacity-100': true, 'opacity-0': false}">
        <button @click="prevSlide" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition">
          &#10094;
        </button>
        <button @click="nextSlide" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition">
          &#10095;
        </button>
      </div>
    </section>

    <!-- 橫向分類篩選列 -->
    <section class="bg-white rounded-lg shadow-md p-6 mb-4">
      <h2 class="text-xl font-bold mb-4 text-gray-800">書籍分類</h2>
      <div class="flex flex-wrap gap-4">
        <div v-for="category in categories" :key="category.id" class="relative group">
          <div class="flex items-center px-4 py-2 rounded-md hover:bg-indigo-50 transition duration-150 ease-in-out cursor-pointer text-gray-700 font-medium"
               :class="{'bg-indigo-100 text-indigo-700 font-medium': filters.mainCategoryId === category.id}"
               @click="toggleMainCategoryFilter(category.id)">
            <span>{{ category.categoryTitle }}</span>
            <svg class="w-4 h-4 text-gray-500 ml-2 transform group-hover:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </div>
          <!-- 次分類浮現 (hover 效果) -->
          <ul class="absolute left-0 top-full mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg opacity-0 group-hover:opacity-100 group-hover:visible transition-all duration-300 invisible z-10">
            <li v-for="subCategory in category.categorySubs" :key="subCategory.id"
                class="p-2 hover:bg-indigo-50 cursor-pointer text-gray-700"
                @click="goToBookSearch('subCategoryId', subCategory.id)">
              {{ subCategory.categorySubTitle }}
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- 熱門借閱前五名 -->
    <section class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">熱門借閱</h2>
      <div class="relative">
        <button @click="scrollBooks('hotBorrowedBooksContainer', -264)" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-300 bg-opacity-75 text-gray-800 p-2 rounded-full hover:bg-opacity-100 transition z-10">
          &#10094;
        </button>
        <!-- 書籍列表 -->
        <div data-ref="hotBorrowedBooksContainer" class="flex overflow-x-auto no-scrollbar pb-4 -mx-2 scroll-smooth">
          <div v-for="book in hotBorrowedBooks" :key="book.id" class="flex-shrink-0 w-64 px-2">
            <!-- 書籍卡片 -->
            <div class="bg-gray-50 rounded-lg shadow-sm overflow-hidden cursor-pointer hover:shadow-md transition flex flex-col"
                 style="width: 240px; height: 420px;">
              <div class="h-[350px] bg-gray-200 flex items-center justify-center overflow-hidden">
                <img :src="book.imageUrl"
                     :alt="book.title"
                     class="h-full w-auto object-cover"
                     onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/64748b?text=無圖片';"
                     @click="goToBookDetail(book.id)">
              </div>
              <!-- 詳情區塊 (固定高度為170px，約為整體高度的2/5) -->
              <div class="p-4 h-[150px] flex flex-col">
                <!-- 標題（兩行） -->
                <!--<h3 class="font-bold text-lg text-gray-800 line-clamp-2 mb-2">{{ book.title }}</h3>-->
                <h3 class="font-bold text-lg text-gray-800 mb-2 overflow-hidden" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; height: 2.75em; line-height: 1.375em;">{{ book.title }}</h3>
                <!-- 作者（一行） -->
                <div class="text-sm text-gray-700 flex items-center mb-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1 text-gray-500 flex-shrink-0">
                    <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd" />
                  </svg>
                  <span class="line-clamp-1">{{ book.authors ? book.authors.join(', ') : '未知作者' }}</span>
                </div>
                <!-- 出版商（一行） -->
                <div class="text-sm text-gray-700 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1 text-gray-500 flex-shrink-0">
                    <path d="M11.584 2.376a.75.75 0 0 1 .832 0l9 6a.75.75 0 1 1-.832 1.248L12 3.901 3.416 9.624a.75.75 0 0 1-.832-1.248l9-6Z" />
                    <path fill-rule="evenodd" d="M5.25 10.5A.75.75 0 0 1 6 9.75v10.5a.75.75 0 0 1-1.5 0V9.75a.75.75 0 0 1 .75-.75Zm2.25 0a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5H9v8.25a.75.75 0 0 1-1.5 0v-9Zm4.5 0a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5H13.5v2.25h2.25a.75.75 0 0 1 0 1.5H13.5v3.75a.75.75 0 0 1-1.5 0v-9Z" clip-rule="evenodd" />
                  </svg>
                  <span class="line-clamp-1">{{ book.publisherName || '未知出版商' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <button @click="scrollBooks('hotBorrowedBooksContainer', 264)" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-300 bg-opacity-75 text-gray-800 p-2 rounded-full hover:bg-opacity-100 transition z-10">
          &#10095;
        </button>
      </div>
    </section>

    <!-- 最新上架前五名 -->
    <section class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">最新上架</h2>
      <div class="relative">
        <button @click="scrollBooks('newArrivalBooksContainer', -264)" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-300 bg-opacity-75 text-gray-800 p-2 rounded-full hover:bg-opacity-100 transition z-10">
          &#10094;
        </button>
        <!-- 書籍列表 -->
        <div data-ref="newArrivalBooksContainer" class="flex overflow-x-auto no-scrollbar pb-4 -mx-2 scroll-smooth">
          <div v-for="book in newArrivalBooks" :key="book.id" class="flex-shrink-0 w-64 px-2">
            <div class="bg-gray-50 rounded-lg shadow-sm overflow-hidden cursor-pointer hover:shadow-md transition flex flex-col"
                 style="width: 240px; height: 420px;">
              <div class="h-[350px] bg-gray-200 flex items-center justify-center overflow-hidden">
                <img :src="book.imageUrl"
                     :alt="book.title"
                     class="h-full w-auto object-cover"
                     onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/64748b?text=無圖片';"
                     @click="goToBookDetail(book.id)">
              </div>
              <!-- 詳情區塊 (固定高度為170px，約為整體高度的2/5) -->
              <div class="p-4 h-[150px] flex flex-col">
                <!-- 標題（兩行） -->
                <!--<h3 class="font-bold text-lg text-gray-800 line-clamp-2 mb-2">{{ book.title }}</h3>-->
                <h3 class="font-bold text-lg text-gray-800 mb-2 overflow-hidden" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; height: 2.75em; line-height: 1.375em;">{{ book.title }}</h3>
                <!-- 作者（一行） -->
                <div class="text-sm text-gray-700 flex items-center mb-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1 text-gray-500 flex-shrink-0">
                    <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd" />
                  </svg>
                  <span class="line-clamp-1">{{ book.authors ? book.authors.join(', ') : '未知作者' }}</span>
                </div>
                <!-- 出版商（一行） -->
                <div class="text-sm text-gray-700 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1 text-gray-500 flex-shrink-0">
                    <path d="M11.584 2.376a.75.75 0 0 1 .832 0l9 6a.75.75 0 1 1-.832 1.248L12 3.901 3.416 9.624a.75.75 0 0 1-.832-1.248l9-6Z" />
                    <path fill-rule="evenodd" d="M5.25 10.5A.75.75 0 0 1 6 9.75v10.5a.75.75 0 0 1-1.5 0V9.75a.75.75 0 0 1 .75-.75Zm2.25 0a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5H9v8.25a.75.75 0 0 1-1.5 0v-9Zm4.5 0a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5H13.5v2.25h2.25a.75.75 0 0 1 0 1.5H13.5v3.75a.75.75 0 0 1-1.5 0v-9Z" clip-rule="evenodd" />
                  </svg>
                  <span class="line-clamp-1">{{ book.publisherName || '未知出版商' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <button @click="scrollBooks('newArrivalBooksContainer', 264)" class="absolute right-0 top-1/2 -translate-y-1/2 bg-gray-300 bg-opacity-75 text-gray-800 p-2 rounded-full hover:bg-opacity-100 transition z-10">
          &#10095;
        </button>
      </div>
    </section>

    <!-- 熱門標籤前十名 -->
    <section class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-bold mb-4 text-gray-800">熱門標籤</h2>
      <div class="flex flex-wrap gap-2">
      <span v-for="tag in hotTags" :key="tag.id"
            class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium cursor-pointer hover:bg-indigo-200 transition"
            @click="goToBookSearch('tags', tag.id)">
        {{ tag.title }}
      </span>
      </div>
    </section>
  </main>

  <!-- 尾部 (footer) -->
  <footer class="bg-gray-800 text-white p-6 mt-8">
    <div class="container mx-auto text-center text-sm">
      <p>&copy; 2025 日比野. 版權所有.</p>
      <div class="mt-2 space-x-4">
        <a href="#" class="hover:underline">關於我們</a>
        <a href="#" class="hover:underline">聯絡我們</a>
        <a href="#" class="hover:underline">隱私政策</a>
      </div>
    </div>
  </footer>


  <!-- 登入模態框 -->
  <div v-if="showLoginModalFlag" class="modal-overlay" @click.self="hideLoginModal">
    <div class="modal-content">
      <button class="close-button" @click="hideLoginModal">&times;</button>
      <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">登入</h2>
      <form @submit.prevent="handleLogin">
        <div class="mb-4">
          <label for="account" class="block text-gray-700 text-sm font-bold mb-2">帳號:</label>
          <input type="text" id="account" v-model="loginForm.account"
                 class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                 required>
        </div>
        <div class="mb-6">
          <label for="password" class="block text-gray-700 text-sm font-bold mb-2">密碼:</label>
          <input type="password" id="password" v-model="loginForm.password"
                 class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
                 required>
        </div>
        <div v-if="loginError" class="text-red-500 text-sm mb-4 text-center">{{ loginError }}</div>
        <div class="flex items-center justify-between">
          <button type="submit"
                  class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline w-full transition-colors duration-200">
            登入
          </button>
        </div>
      </form>
      <div class="mt-4 text-center">
        <a href="/html/register" class="text-indigo-600 hover:text-indigo-800 text-sm font-semibold">
          還沒有帳號？加入會員
        </a>
      </div>
    </div>
  </div>

</div>

<!-- Vue.js 3 CDN 更新成組合式 -->
<script>
  const { createApp, ref, reactive, onMounted, nextTick } = Vue;

  createApp({
    setup() {
      // 響應式數據
      const categories = ref([]);
      const hotBorrowedBooks = ref([]);
      const newArrivalBooks = ref([]);
      const hotTags = ref([]);
      const carouselImages = ref([
        'https://becomingatranslator.wordpress.com/wp-content/uploads/2014/01/baigaeshi2.jpg',
        'https://pic.pimg.tw/erikasky/1380365655-2901437797.jpg',
        'https://kenshin.hk/blog/2020-02/hanzawa2/02/hanzawa2-02-00.jpg',
        'https://kenshin.hk/blog/2020-02/hanzawa2/03/hanzawa2-03-00.jpg',
        'https://placehold.co/1200x400/a78bfa/ffffff?text=ADVERTISEMENT 01',
        'https://placehold.co/1200x400/818cf8/ffffff?text=ADVERTISEMENT 02',
        'https://placehold.co/1200x400/6366f1/ffffff?text=ADVERTISEMENT 03'
      ]);
      const currentSlideIndex = ref(0);
      const filters = reactive({ // filters 物件來追蹤選中的主類別
        mainCategoryId: null
      });

      // --- 核心修改：登入相關狀態 ---
      const showLoginModalFlag = ref(false);
      const loginForm = ref({ account: '', password: '' });
      const loginError = ref('');
      const isLoggedIn = ref(false);
      const currentUserId = ref(null); // 從 JWT 獲取的使用者 ID
      const currentUserRole = ref(null); // 從 JWT 獲取的使用者角色
      const currentUsername = ref(null); // 新增：儲存使用者帳號

      // --- Axios Interceptor (自動添加 JWT) ---
      axios.interceptors.request.use(
              config => {
                const token = localStorage.getItem('jwtToken');
                if (token) {
                  config.headers.Authorization = `Bearer ${token}`;
                }
                return config;
              },
              error => Promise.reject(error)
      );

      // --- 核心修改：登出邏輯 ---
      const logout = () => {
        localStorage.removeItem('jwtToken'); // 只需移除 token
        // 【修正】登出後直接重新整理頁面，讓 onMounted 重新執行 checkLoginStatus
        alert('已登出。');
        window.location.reload();
      };

      // --- 核心修改：檢查登入狀態的邏輯 ---
      /** TODO myPage index 的 jwt 解析方式略不同，待統一改 jose **/
      const checkLoginStatus = () => {
        // 現在只需檢查 token 是否存在及其有效性
        const token = localStorage.getItem('jwtToken');
        if (token) {
          try {
            // 1. 解碼 JWT 的 Payload 部分
            const payloadBase64 = token.split('.')[1];
            const base64 = payloadBase64.replace(/-/g, '+').replace(/_/g, '/'); // 增強解碼，處理 URL 安全的 Base64
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            const decodedPayload = JSON.parse(jsonPayload);
            // 2. 檢查 token 是否過期 (exp 是標準的過期時間聲明，單位是秒)
            if (decodedPayload.exp * 1000 < Date.now()) {
              // JWT 的 exp 欄位是以「秒」為單位的 UNIX 時間戳，而 JavaScript 的 Date.now() 回傳的是「毫秒」。
              // 所以這裡 decodedPayload.exp \* 1000 是把秒轉成毫秒，才能和 Date.now() 正確比較。
              // 是為了在頁面操作時即時判斷 JWT 是否已過期，避免使用已失效的 token 發送 API 請求。
              console.log("Token 已過期。");
              // 如果 token 過期，只移除 token 並重設狀態，不呼叫 logout() 避免無限循環
              localStorage.removeItem('jwtToken');
              isLoggedIn.value = false;
              currentUserId.value = null;
              currentUserRole.value = null;
              currentUsername.value = null;
              return;
            }
            // 3. 從解碼後的 payload 中取得資訊並更新狀態
            isLoggedIn.value = true;
            currentUserId.value = parseInt(decodedPayload.sub); // 'sub' 是使用者 ID
            currentUserRole.value = decodedPayload.role;       // 'role' 是自訂聲明
            currentUsername.value = decodedPayload.username; // 'username' 也是自訂聲明

          } catch (e) {
            console.error("無法解碼 JWT:", e);
            // 如果 token 格式錯誤，同樣只移除 token 並重設狀態
            localStorage.removeItem('jwtToken');
            isLoggedIn.value = false;
            currentUserId.value = null;
            currentUserRole.value = null;
            currentUsername.value = null;
          }
        } else {
          // 如果沒有 token，就是未登入狀態
          isLoggedIn.value = false;
          currentUserId.value = null;
          currentUserRole.value = null;
          currentUsername.value = null;
        }
      };

      // 顯示登入模態框
      const showLoginModal = () => {
        showLoginModalFlag.value = true;
        loginError.value = ''; // 清除之前的錯誤訊息
        loginForm.value = { account: '', password: '' }; // 重置表單
      };

      // 隱藏登入模態框
      const hideLoginModal = () => {
        showLoginModalFlag.value = false;
      };

      // --- 核心修改：處理登入請求 ---
      const handleLogin = async () => {
        loginError.value = ''; // 清除錯誤訊息
        try {
          const response = await axios.post('/api/auth/login', loginForm.value);
          console.log(response.data);
          const { jwtToken } = response.data;

          localStorage.setItem('jwtToken', jwtToken);

          alert('登入成功！');
          // 【修正】登入成功後，直接重新整理頁面
          window.location.reload();

        } catch (error) {
          console.error('登入失敗:', error);
          loginError.value = error.response?.data?.message || '帳號或密碼錯誤，請重試。';
        }
      };

      // 共用方法，用於導航到書籍搜尋頁面
      const goToBookSearch = (filterType, id) => {
        const params = new URLSearchParams();
        if (filterType === 'keyword') {
          params.set('keyword', filterType);
        } else if (filterType === 'mainCategoryId') {
          params.append('mainCategoryId', id);
        } else if (filterType === 'subCategoryId') {
          params.append('subCategoryId', id);
        } else if (filterType === 'authorId') {
          params.append('authorId', id);
        } else if (filterType === 'publisherId') {
          params.append('publisherId', id);
        } else if (filterType === 'seriesId') {
          params.append('seriesId', id);
        } else if (filterType === 'tags') {
          params.append('tagIds', id);
        }
        window.location.href = `/bookQuery?${params.toString()}`;
      };

      // 點擊書籍卡片導向詳情頁面
      const goToBookDetail = (bookId) => {
        window.location.href = `/oneBook?id=${bookId}`;
      };

      const fetchCategories = async () => {
        try {
          const response = await fetch('/api/categories');
          categories.value = await response.json();
        } catch (error) {
          console.error('Error fetching categories:', error);
        }
      };

      const fetchHotBorrowedBooks = async () => {
        let url = '/api/books/home/top5loan';
        if (filters.mainCategoryId) {
          url += `/${filters.mainCategoryId}`;
        }
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`API 請求失敗: ${response.status}`);
          hotBorrowedBooks.value = await response.json();
        } catch (error) {
          console.error('Error fetching hot borrowed books:', error);
        }
      };

      const fetchNewArrivalBooks = async () => {
        let url = '/api/books/home/top5new';
        if (filters.mainCategoryId) {
          url += `/${filters.mainCategoryId}`;
        }
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`API 請求失敗: ${response.status}`);
          newArrivalBooks.value = await response.json();
        } catch (error) {
          console.error('Error fetching new arrival books:', error);
        }
      };

      const fetchHotTags = async () => {
        let url = '/api/tags/home/top10';
        if (filters.mainCategoryId) {
          url += `/${filters.mainCategoryId}`;
        }
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`API 請求失敗: ${response.status}`);
          hotTags.value = await response.json();
        } catch (error) {
          console.error('Error fetching hot tags:', error);
        }
      };

      // 統一獲取首頁所有動態內容
      const fetchHomepageContent = () => {
        fetchHotBorrowedBooks();
        fetchNewArrivalBooks();
        fetchHotTags();
      };

      // 新增方法：切換主類別篩選
      const toggleMainCategoryFilter = (id) => {
        filters.mainCategoryId = filters.mainCategoryId === id ? null : id;
        fetchHomepageContent();
      };

      const startCarousel = () => {
        setInterval(nextSlide, 5000);
      };

      const nextSlide = () => {
        currentSlideIndex.value = (currentSlideIndex.value + 1) % carouselImages.value.length;
      };

      const prevSlide = () => {
        currentSlideIndex.value = (currentSlideIndex.value - 1 + carouselImages.value.length) % carouselImages.value.length;
      };

      // 新增：水平滾動書籍列表
      const scrollBooks = async (containerRef, amount) => {
        await nextTick();
        const container = document.querySelector(`[data-ref="${containerRef}"]`);
        if (container) {
          container.scrollBy({ left: amount, behavior: 'smooth' });
        }
      };


      // 彩蛋
      const easterEggActive = ref(false);
      let easterEggTimer = null;

      const startEasterEgg = () => {
        easterEggTimer = setTimeout(() => {
          easterEggActive.value = true;
          nextTick(() => {
            const el = document.querySelector('.easter-egg-gradient');
            if (el) el.classList.add('easter-egg-animate');
          });
        }, 5000);
      };

      const cancelEasterEgg = () => {
        clearTimeout(easterEggTimer);
        easterEggActive.value = false;
        nextTick(() => {
          const el = document.querySelector('.easter-egg-gradient');
          if (el) el.classList.remove('easter-egg-animate');
        });
      };

      const goToEasterEgg = () => {
        if (easterEggActive.value) {
          console.log('被你發現了');
          window.location.href = '/html/other/外觀0817/0817index.html';
        }
      };

      // 生命週期鉤子，組件掛載時獲取數據
      onMounted(() => {
        checkLoginStatus(); // 頁面載入時立即檢查登入狀態
        fetchCategories();
        fetchHomepageContent();
        startCarousel();
      });

      // 返回所有需要在模板中使用的數據和方法
      return {
        categories,
        hotBorrowedBooks,
        newArrivalBooks,
        hotTags,
        carouselImages,
        currentSlideIndex,
        filters,
        goToBookSearch,
        goToBookDetail,
        toggleMainCategoryFilter,
        nextSlide,
        prevSlide,
        scrollBooks,

        // 登入相關
        showLoginModalFlag,
        loginForm,
        loginError,

        isLoggedIn,
        currentUserId,
        currentUserRole,
        showLoginModal,
        hideLoginModal,
        handleLogin,
        logout,

        // 彩蛋
        easterEggActive,
        startEasterEgg,
        cancelEasterEgg,
        goToEasterEgg,
      };
    }
  }).mount('#app');
</script>
</body>
</html>