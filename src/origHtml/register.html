<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>註冊 - 日比野線上圖書館</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue.js CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Axios CDN -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .lucide {
      display: inline-block;
      width: 1em;
      height: 1em;
      stroke-width: 2;
      stroke: currentColor;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .input-group {
      position: relative;
    }
    .toggle-password {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #6B7280; /* gray-500 */
    }
    .toggle-password:hover {
      color: #4B5563; /* gray-700 */
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gray-100">

<div id="app" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
  <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">註冊</h2>

  <form @submit.prevent="handleRegister">
    <div class="mb-4">
      <label for="account" class="block text-gray-700 text-sm font-bold mb-2">帳號:</label>
      <input type="text" id="account" v-model="registerForm.account"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
             required>
    </div>

    <div class="mb-4 input-group">
      <label for="password" class="block text-gray-700 text-sm font-bold mb-2">密碼:</label>
      <input :type="passwordFieldType" id="password" v-model="registerForm.password"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline pr-10"
             required minlength="6">
      <span class="toggle-password" @click="togglePasswordVisibility">
                <svg v-if="passwordFieldType === 'password'" class="lucide lucide-eye w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                <svg v-else class="lucide lucide-eye-off w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-10-7-10-7a1.8 1.8 0 0 1 .28-.79"/><path d="M2.81 2.81 2 2.81 2 2.81Z"/><path d="M18.19 6.06A10.07 10.07 0 0 1 22 12c0 0-3 7-10 7a1.8 1.8 0 0 1-.79-.28"/><path d="m21.19 21.19-1.25-1.25"/><path d="M6.06 18.19 2.81 14.94"/><path d="m14.94 6.06-1.25-1.25"/><path d="M12 9a3 3 0 0 1 3 3"/><path d="M12 15a3 3 0 0 1-3-3"/></svg>
            </span>
    </div>

    <div class="mb-4">
      <label for="confirmPassword" class="block text-gray-700 text-sm font-bold mb-2">確認密碼:</label>
      <input :type="passwordFieldType" id="confirmPassword" v-model="confirmPassword"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline pr-10"
             required>
      <p v-if="passwordMismatch" class="text-red-500 text-xs italic mt-1">兩次輸入的密碼不一致。</p>
    </div>

    <div class="mb-4">
      <label for="name" class="block text-gray-700 text-sm font-bold mb-2">姓名:</label>
      <input type="text" id="name" v-model="registerForm.name"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
             required>
    </div>

    <div class="mb-4">
      <label for="email" class="block text-gray-700 text-sm font-bold mb-2">電子郵件:</label>
      <input type="email" id="email" v-model="registerForm.email"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
             required>
    </div>

    <div class="mb-4">
      <label for="phone" class="block text-gray-700 text-sm font-bold mb-2">電話:</label>
      <input type="tel" id="phone" v-model="registerForm.phone"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
    </div>

    <div class="mb-6">
      <label for="address" class="block text-gray-700 text-sm font-bold mb-2">地址:</label>
      <input type="text" id="address" v-model="registerForm.address"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
    </div>

    <div v-if="registrationMessage" :class="{'text-green-500': isSuccess, 'text-red-500': !isSuccess}"
         class="text-center mb-4 text-sm">
      {{ registrationMessage }}
    </div>

    <div class="flex items-center justify-between">
      <button type="submit"
              :disabled="passwordMismatch"
              class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline w-full transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
        註冊
      </button>
    </div>
  </form>

  <div class="mt-6 text-center">
    <a href="/" class="text-indigo-600 hover:text-indigo-800 text-sm font-semibold">
      返回首頁
    </a>
  </div>
</div>

<script>
  const { createApp, ref, computed, onMounted } = Vue;

  createApp({
    setup() {
      const registerForm = ref({
        account: '',
        password: '',
        name: '',
        email: '',
        phone: '',
        address: ''
      });
      const confirmPassword = ref('');
      const passwordFieldType = ref('password'); // 控制密碼輸入框類型
      const registrationMessage = ref('');
      const isSuccess = ref(false);

      // 計算屬性：檢查兩次密碼是否一致
      const passwordMismatch = computed(() => {
        return registerForm.value.password !== confirmPassword.value && confirmPassword.value !== '';
      });

      // 切換密碼顯示/隱藏
      const togglePasswordVisibility = () => {
        passwordFieldType.value = passwordFieldType.value === 'password' ? 'text' : 'password';
      };

      // 處理註冊表單提交
      const handleRegister = async () => {
        registrationMessage.value = ''; // 清除之前的訊息
        isSuccess.value = false;

        if (passwordMismatch.value) {
          registrationMessage.value = '兩次輸入的密碼不一致，請檢查。';
          return;
        }
        if (registerForm.value.password.length < 6) {
          registrationMessage.value = '密碼長度至少為6個字元。';
          return;
        }

        try {
          // 發送註冊請求到後端
          const response = await axios.post('/api/users/register', registerForm.value);

          if (response.data.success) {
            isSuccess.value = true;
            registrationMessage.value = '註冊成功，請重新登錄。';
            // 可選：延遲跳轉回登入頁面
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          } else {
            isSuccess.value = false;
            registrationMessage.value = response.data.message || '註冊失敗，請稍後再試。';
          }
        } catch (error) {
          console.error('註冊請求失敗:', error);
          isSuccess.value = false;
          if (error.response && error.response.data && error.response.data.message) {
            registrationMessage.value = `註冊失敗: ${error.response.data.message}`;
          } else if (error.response && error.response.status === 409) { // 假設 409 Conflict 表示帳號或郵件已存在
            registrationMessage.value = '註冊失敗：帳號或電子郵件已存在。';
          }
          else {
            registrationMessage.value = '註冊時發生錯誤，請稍後再試。';
          }
        }
      };

      onMounted(() => {
        lucide.createIcons(); // 渲染 Lucide Icons
      });

      return {
        registerForm,
        confirmPassword,
        passwordFieldType,
        registrationMessage,
        isSuccess,
        passwordMismatch,
        togglePasswordVisibility,
        handleRegister
      };
    }
  }).mount('#app');
</script>
</body>
</html>
